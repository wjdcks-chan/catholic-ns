<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒíšŒ ë¬¼í’ˆ ëŒ€ì—¬ ì¥ë¶€ (ì‹¤ì‹œê°„)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #ffffff; }
    h1 { margin-bottom: 10px; }
    .notice-box {
      background: #f7f7f7;
      border: 1px solid #ddd;
      padding: 10px 14px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.7;
    }
    .top-area { margin-bottom: 15px; }
    .form-area { margin-bottom: 20px; }
    select, input, button { padding: 6px; margin-right: 6px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
    th { background: #f2f2f2; }
    button { cursor: pointer; }
    button:disabled { opacity: 0.5; }
    .reset-btn { background: #eee; }
  </style>
</head>
<body>

<h1>í•™ìƒíšŒ ë¬¼í’ˆ ëŒ€ì—¬ ì¥ë¶€ (ì‹¤ì‹œê°„)</h1>

<div class="notice-box">
  âœ” ë¬¼í’ˆ ëŒ€ì—¬ëŠ” ìš´ì˜ ì‹œê°„ 10ì‹œ~18ì‹œ ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
  âœ” ë°˜ë‚©ì€ í•™ìƒíšŒ ë‹´ë‹¹ì í™•ì¸ í›„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
</div>

<div class="top-area">
  <button class="reset-btn" id="resetBtn">ì´ˆê¸°í™” (ìƒˆ ì¥ë¶€)</button>
</div>

<div class="form-area">
  <select id="itemSelect"></select>
  <select id="itemNoSelect"></select>
  <input id="nameInput" placeholder="ì´ë¦„">
  <input id="studentIdInput" placeholder="í•™ë²ˆ">
  <button id="rentBtn">ëŒ€ì—¬í•˜ê¸°</button>
</div>

<table>
  <thead>
    <tr>
      <th>ë²ˆí˜¸</th><th>ë¬¼í’ˆ</th><th>ë¬¼í’ˆë²ˆí˜¸</th>
      <th>ì´ë¦„</th><th>í•™ë²ˆ</th>
      <th>ëŒ€ì—¬ ì‹œê°</th><th>ë°˜ë‚© ì‹œê°</th><th>ë°˜ë‚©</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, doc, collection, query, orderBy,
  onSnapshot, getDoc, setDoc, runTransaction, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* =========================
   ğŸ”¥ ì—¬ê¸°ì— ë„¤ firebaseConfig ë¶™ì—¬ë„£ê¸°
========================= */

const firebaseConfig = {
  apiKey: "ì—¬ê¸°ì—_ë³µì‚¬í•œ_apiKey",
  authDomain: "ì—¬ê¸°ì—_authDomain",
  projectId: "ì—¬ê¸°ì—_projectId",
  appId: "ì—¬ê¸°ì—_appId",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========================= */

const ADMIN_PASSWORD = "ì •ì°¬";

const ITEMS = ["ì‹¤í—˜ë³µ", "ê³„ì‚°ê¸°", "ì»´í“¨í„°ì‚¬ì¸íœ", "í™”ì´íŠ¸"];
const ITEM_NO_MAP = Object.fromEntries(
  ITEMS.map(item => [item, Array.from({ length: 10 }, (_, i) => String(i + 1))])
);

const itemSelect = document.getElementById("itemSelect");
const itemNoSelect = document.getElementById("itemNoSelect");
const nameInput = document.getElementById("nameInput");
const studentIdInput = document.getElementById("studentIdInput");
const rentBtn = document.getElementById("rentBtn");
const tableBody = document.getElementById("tableBody");
const resetBtn = document.getElementById("resetBtn");

let currentLedgerId = null;
let records = [];
const activeRentedKeys = new Set();

function now() {
  return new Date().toLocaleString("ko-KR");
}

function makeKey(item, itemNo) {
  return `${item}::${itemNo}`;
}

/* ====== Ledger ====== */

async function ensureLedger() {
  const metaRef = doc(db, "meta", "current");
  const metaSnap = await getDoc(metaRef);

  if (!metaSnap.exists()) {
    const ledgerId = `ledger_${Date.now()}`;
    await setDoc(metaRef, { ledgerId, updatedAt: serverTimestamp() });
  }
}

function subscribeLedger(ledgerId) {
  const rentalsCol = collection(db, "ledgers", ledgerId, "rentals");
  const q = query(rentalsCol, orderBy("createdAtMs", "asc"));

  onSnapshot(q, (snap) => {
    records = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    refreshUI();
  });
}

async function boot() {
  await ensureLedger();
  const metaRef = doc(db, "meta", "current");

  onSnapshot(metaRef, (snap) => {
    const ledgerId = snap.data()?.ledgerId;
    if (!ledgerId) return;
    if (currentLedgerId !== ledgerId) {
      currentLedgerId = ledgerId;
      subscribeLedger(currentLedgerId);
    }
  });
}

/* ====== UI ====== */

function initItems() {
  ITEMS.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item;
    opt.textContent = item;
    itemSelect.appendChild(opt);
  });
}

function rebuildActive() {
  activeRentedKeys.clear();
  for (const r of records) {
    if (!r.returnTime) {
      activeRentedKeys.add(makeKey(r.item, r.itemNo));
    }
  }
}

function updateItemNo() {
  const item = itemSelect.value;
  const list = ITEM_NO_MAP[item];
  itemNoSelect.innerHTML = "";

  list.forEach(no => {
    const opt = document.createElement("option");
    opt.value = no;
    const rented = activeRentedKeys.has(makeKey(item, no));
    opt.disabled = rented;
    opt.textContent = rented ? `${no}ë²ˆ (ëŒ€ì—¬ì¤‘)` : `${no}ë²ˆ`;
    itemNoSelect.appendChild(opt);
  });
}

function renderTable() {
  tableBody.innerHTML = "";
  let i = 1;

  for (const r of records) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${i++}</td>
      <td>${r.item}</td>
      <td>${r.itemNo}</td>
      <td>${r.name}</td>
      <td>${r.studentId}</td>
      <td>${r.rentTime}</td>
      <td>${r.returnTime || ""}</td>
      <td></td>
    `;

    const btn = document.createElement("button");
    btn.textContent = "ë°˜ë‚©";
    btn.disabled = !!r.returnTime;
    btn.onclick = () => returnItem(r.id);

    tr.lastElementChild.appendChild(btn);
    tableBody.appendChild(tr);
  }
}

function refreshUI() {
  rebuildActive();
  updateItemNo();
  renderTable();
}

/* ====== ê¸°ëŠ¥ ====== */

async function rentItem() {
  const name = nameInput.value.trim();
  const studentId = studentIdInput.value.trim();
  const item = itemSelect.value;
  const itemNo = itemNoSelect.value;

  if (!name || !studentId) {
    alert("ì´ë¦„ê³¼ í•™ë²ˆ ì…ë ¥");
    return;
  }

  const key = makeKey(item, itemNo);
  const lockRef = doc(db, "ledgers", currentLedgerId, "locks", key);
  const rentalsCol = collection(db, "ledgers", currentLedgerId, "rentals");
  const id = crypto.randomUUID();

  try {
    await runTransaction(db, async (tx) => {
      const lockSnap = await tx.get(lockRef);
      if (lockSnap.exists()) {
        throw new Error("ì´ë¯¸ ëŒ€ì—¬ì¤‘ì…ë‹ˆë‹¤.");
      }

      tx.set(lockRef, { createdAt: serverTimestamp() });
      tx.set(doc(rentalsCol, id), {
        item,
        itemNo,
        name,
        studentId,
        rentTime: now(),
        returnTime: null,
        createdAtMs: Date.now()
      });
    });

    nameInput.value = "";
    studentIdInput.value = "";

  } catch (e) {
    alert(e.message);
  }
}

async function returnItem(id) {
  if (prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸") !== ADMIN_PASSWORD) {
    alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    return;
  }

  const record = records.find(r => r.id === id);
  if (!record) return;

  const key = makeKey(record.item, record.itemNo);
  const lockRef = doc(db, "ledgers", currentLedgerId, "locks", key);
  const recordRef = doc(db, "ledgers", currentLedgerId, "rentals", id);

  await runTransaction(db, async (tx) => {
    tx.update(recordRef, { returnTime: now() });
    tx.delete(lockRef);
  });
}

async function resetAll() {
  if (prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸") !== ADMIN_PASSWORD) return;
  const metaRef = doc(db, "meta", "current");
  await setDoc(metaRef, { ledgerId: `ledger_${Date.now()}`, updatedAt: serverTimestamp() });
}

itemSelect.addEventListener("change", updateItemNo);
rentBtn.addEventListener("click", rentItem);
resetBtn.addEventListener("click", resetAll);

initItems();
boot();
</script>

</body>
</html>
